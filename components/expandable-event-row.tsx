"use client";

import { useState } from "react";
import Link from "next/link";
import type { Event } from "@/lib/db/schema";

interface Session {
  id: string;
  sessionName: string;
  sessionDate: string | null;
  sequenceInEvent: number | null;
}

interface ChildEvent {
  id: string;
  eventName: string;
  eventType: string | null;
  eventDateStart: string | null;
}

interface ExpandableEventRowProps {
  event: Event;
  parentEventName: string | null;
  childEventCount: number;
  sessionCount: number;
  assetCount: number;
  index: number;
}

export function ExpandableEventRow({
  event,
  parentEventName,
  childEventCount,
  sessionCount,
  assetCount,
  index,
}: ExpandableEventRowProps) {
  const [isExpanded, setIsExpanded] = useState(false);
  const [childEvents, setChildEvents] = useState<ChildEvent[]>([]);
  const [sessions, setSessions] = useState<Session[]>([]);
  const [isLoading, setIsLoading] = useState(false);

  const hasChildren = childEventCount > 0 || sessionCount > 0;

  const handleRowClick = async () => {
    if (!isExpanded && hasChildren && childEvents.length === 0 && sessions.length === 0) {
      setIsLoading(true);
      try {
        const promises = [];

        if (childEventCount > 0) {
          promises.push(
            fetch(`/api/events/${event.id}/children`).then(res => res.json())
          );
        } else {
          promises.push(Promise.resolve([]));
        }

        if (sessionCount > 0) {
          promises.push(
            fetch(`/api/events/${event.id}/sessions`).then(res => res.json())
          );
        } else {
          promises.push(Promise.resolve([]));
        }

        const [childEventsData, sessionsData] = await Promise.all(promises);
        setChildEvents(childEventsData);
        setSessions(sessionsData);
      } catch (error) {
        console.error("Failed to fetch children:", error);
      } finally {
        setIsLoading(false);
      }
    }
    setIsExpanded(!isExpanded);
  };

  return (
    <>
      <tr
        className="border-b hover:bg-muted/50 cursor-pointer"
        onClick={handleRowClick}
      >
        <td className="px-4 py-3 text-sm text-muted-foreground">
          {hasChildren && (
            <span className="mr-2">{isExpanded ? "▼" : "▶"}</span>
          )}
          {index + 1}
        </td>
        <td className="px-4 py-3 text-sm">
          <div>
            {event.eventName}
            {parentEventName && (
              <div className="text-xs text-muted-foreground italic mt-0.5">
                ↑ {parentEventName}
              </div>
            )}
          </div>
        </td>
        <td className="px-4 py-3 text-sm">{event.eventType || "—"}</td>
        <td className="px-4 py-3 text-sm">
          {event.eventDateStart && event.eventDateEnd
            ? `${event.eventDateStart} to ${event.eventDateEnd}`
            : event.eventDateStart || "—"}
        </td>
        <td className="px-4 py-3 text-sm">
          {event.city && event.country
            ? `${event.city}, ${event.country}`
            : event.country || "—"}
        </td>
        <td className="px-4 py-3 text-sm">
          <span
            className={`inline-flex items-center rounded-full px-2 py-1 text-xs font-medium ${
              childEventCount > 0
                ? "bg-orange-100 text-orange-700"
                : "bg-gray-100 text-gray-700"
            }`}
          >
            {childEventCount}
          </span>
        </td>
        <td className="px-4 py-3 text-sm">
          <span
            className={`inline-flex items-center rounded-full px-2 py-1 text-xs font-medium ${
              sessionCount > 0
                ? "bg-purple-100 text-purple-700"
                : "bg-gray-100 text-gray-700"
            }`}
          >
            {sessionCount}
          </span>
        </td>
        <td className="px-4 py-3 text-sm">
          <span
            className={`inline-flex items-center rounded-full px-2 py-1 text-xs font-medium ${
              assetCount > 0
                ? "bg-blue-100 text-blue-700"
                : "bg-gray-100 text-gray-700"
            }`}
          >
            {assetCount}
          </span>
        </td>
        <td className="px-4 py-3 text-sm">
          <span
            className={`inline-flex items-center rounded-full px-2 py-1 text-xs font-medium ${
              event.catalogingStatus === "Ready"
                ? "bg-green-100 text-green-700"
                : event.catalogingStatus === "In Progress"
                ? "bg-yellow-100 text-yellow-700"
                : "bg-gray-100 text-gray-700"
            }`}
          >
            {event.catalogingStatus || "Not Started"}
          </span>
        </td>
        <td className="px-4 py-3 text-sm" onClick={(e) => e.stopPropagation()}>
          <Link
            href={`/events/${event.id}`}
            className="text-blue-600 hover:underline"
          >
            View
          </Link>
        </td>
      </tr>
      {isExpanded && hasChildren && (
        <tr>
          <td colSpan={11} className="px-4 py-2 bg-muted/30">
            {isLoading ? (
              <div className="text-sm text-muted-foreground py-2">
                Loading...
              </div>
            ) : (
              <div className="pl-8 py-2 space-y-4">
                {childEventCount > 0 && (
                  <div>
                    <div className="text-xs font-semibold text-muted-foreground mb-2">
                      Child Events ({childEventCount}):
                    </div>
                    <div className="space-y-1">
                      {childEvents.map((childEvent) => (
                        <div key={childEvent.id} className="text-sm">
                          <Link
                            href={`/events/${childEvent.id}`}
                            className="text-orange-600 hover:underline inline-flex items-center gap-2"
                          >
                            <span>{childEvent.eventName}</span>
                            {childEvent.eventType && (
                              <span className="text-xs text-muted-foreground">
                                ({childEvent.eventType})
                              </span>
                            )}
                            {childEvent.eventDateStart && (
                              <span className="text-xs text-muted-foreground">
                                - {childEvent.eventDateStart}
                              </span>
                            )}
                          </Link>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {sessionCount > 0 && (
                  <div>
                    <div className="text-xs font-semibold text-muted-foreground mb-2">
                      Sessions ({sessionCount}):
                    </div>
                    <div className="space-y-1">
                      {sessions.map((session) => (
                        <div key={session.id} className="text-sm">
                          <Link
                            href={`/sessions/${session.id}`}
                            className="text-blue-600 hover:underline inline-flex items-center gap-2"
                          >
                            <span className="font-mono text-xs text-muted-foreground">
                              {session.sequenceInEvent
                                ? `#${session.sequenceInEvent}`
                                : "—"}
                            </span>
                            <span>{session.sessionName}</span>
                            {session.sessionDate && (
                              <span className="text-xs text-muted-foreground">
                                ({session.sessionDate})
                              </span>
                            )}
                          </Link>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}
          </td>
        </tr>
      )}
    </>
  );
}
